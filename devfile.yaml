schemaVersion: 2.2.2
metadata:
  name: opencode-workspace
  description: Development environment with OpenCode AI coding agent ready to use
attributes:
  controller.devfile.io/storage-type: per-user
components:
  - name: dev
    container:
      image: quay.io/devfile/universal-developer-image:ubi8-latest
      memoryRequest: 2Gi
      memoryLimit: 6Gi
      cpuRequest: 1000m
      cpuLimit: 4000m
      mountSources: true
      env:
        - name: SHELL
          value: /bin/bash
commands:
  - id: setup-opencode
    exec:
      component: dev
      commandLine: |
        curl -fsSL https://opencode.ai/install | bash
        cat > "$HOME/.opencode-init.sh" << 'INITEOF'
        export PATH="$HOME/.opencode/bin:$PATH"
        if [ ! -f /tmp/.opencode-launched ] && command -v opencode &>/dev/null; then
          touch /tmp/.opencode-launched
          opencode
        fi
        INITEOF
        grep -q opencode-init "$HOME/.bashrc" 2>/dev/null || echo '[ -f "$HOME/.opencode-init.sh" ] && source "$HOME/.opencode-init.sh"' >> "$HOME/.bashrc"
      workingDir: ${PROJECT_SOURCE}
events:
  postStart:
    - setup-opencode
